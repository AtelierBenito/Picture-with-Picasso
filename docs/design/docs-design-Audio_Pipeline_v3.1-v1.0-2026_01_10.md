# Audio Pipeline Design - Picture with Picasso v3.1

**Version:** v1.0-2026-01-10
**Purpose:** Detailed design for adding audio to Kling O1 silent videos
**Related Research:** `docs/research/docs-research-Lip_Sync_Audio_Pipeline-v1.0-2026_01_10.md`

---

## Design Overview

### Objective
Add synchronized audio to silent videos generated by Kling O1, featuring:
- Spanish-accented Picasso voice
- Natural reunion dialog
- Ambient period-authentic sounds

### Architecture Summary
```
v3.0 Kling Output (Silent) → TTS → Lip Sync → v3.1 Output (With Audio)
```

### Node Count
**Total New Nodes: 11**

| Stage | Nodes | Purpose |
|-------|-------|---------|
| Script Generation | 1 | Define dialog text |
| ElevenLabs TTS | 5 | Submit, Wait, Get Result, Check Status, Loop |
| LatentSync | 5 | Submit, Wait, Get Result, Check Status, Loop |

---

## Workflow Integration Point

### Current v3.0 Exit Point
```
Download Kling Video1 → [Archive + Route Output]
```

### New v3.1 Flow
```
Download Kling Video1 → Prepare Dialog Script → [TTS Pipeline] → [Lip Sync Pipeline] → [Archive + Route Output]
```

The audio pipeline inserts between video download and output routing.

---

## Node Specifications

### Stage 1: Script Generation

#### Node 1: Prepare Dialog Script
**Type:** Set Node
**Name:** `Prepare Dialog Script`
**Position:** After `Download Kling Video1`

**Fields:**
```json
{
  "dialogScript": "Ah, mi amigo! Welcome, welcome! Ha ha ha! It is so good to see you! Come, come!",
  "voiceId": "pNInz6obpgDQGcFmaJgB",
  "videoUrl": "={{ $json.data.video.url }}"
}
```

**Notes:**
- `dialogScript`: ~10 seconds of dialog
- `voiceId`: ElevenLabs Spanish-accented male voice ID (to be configured)
- `videoUrl`: Carries forward the Kling video URL

---

### Stage 2: ElevenLabs TTS Pipeline

#### Node 2: Submit to ElevenLabs TTS
**Type:** HTTP Request
**Name:** `Submit to ElevenLabs TTS`
**Position:** After `Prepare Dialog Script`

**Configuration:**
| Field | Value |
|-------|-------|
| Method | POST |
| URL | `https://queue.fal.run/fal-ai/elevenlabs/tts/multilingual-v2` |
| Authentication | Generic Credential Type (Header Auth) |
| Send Headers | On |
| Header Name | `Authorization` |
| Header Value | `Key {{ $('Workflow Configuration').item.json.falApiKey }}` |
| Send Body | On |
| Body Type | JSON |

**JSON Body:**
```javascript
={{ JSON.stringify({
  "text": $json.dialogScript,
  "voice_id": $json.voiceId,
  "model_id": "eleven_multilingual_v2"
}) }}
```

**Output:**
```json
{
  "request_id": "abc123...",
  "response_url": "https://queue.fal.run/fal-ai/elevenlabs/tts/multilingual-v2/requests/abc123..."
}
```

---

#### Node 3: Wait for TTS
**Type:** Wait
**Name:** `Wait for TTS`
**Position:** After `Submit to ElevenLabs TTS`

**Configuration:**
| Field | Value |
|-------|-------|
| Resume | After Time Interval |
| Wait Amount | 3 |
| Wait Unit | Seconds |

---

#### Node 4: Get TTS Result
**Type:** HTTP Request
**Name:** `Get TTS Result`
**Position:** After `Wait for TTS`

**Configuration:**
| Field | Value |
|-------|-------|
| Method | GET |
| URL | `={{ $('Submit to ElevenLabs TTS').item.json.response_url }}` |
| Authentication | Generic Credential Type (Header Auth) |
| Send Headers | On |
| Header Name | `Authorization` |
| Header Value | `Key {{ $('Workflow Configuration').item.json.falApiKey }}` |
| Response Format | JSON |

---

#### Node 5: Check TTS Status
**Type:** IF
**Name:** `Check TTS Status`
**Position:** After `Get TTS Result`

**Conditions:**
```
Value 1: {{ $json.status }}
Operation: equals
Value 2: COMPLETED
```

**TRUE branch:** Continue to Submit to LatentSync
**FALSE branch:** Continue to TTS Loop Check

---

#### Node 6: TTS Loop Check
**Type:** IF
**Name:** `TTS Loop Check`
**Position:** FALSE branch of `Check TTS Status`

**Conditions:**
Check if max retries exceeded (similar to existing Kling pattern)

**TRUE branch:** Error handling
**FALSE branch:** Loop back to `Wait for TTS`

---

### Stage 3: LatentSync Pipeline

#### Node 7: Submit to LatentSync
**Type:** HTTP Request
**Name:** `Submit to LatentSync`
**Position:** After `Check TTS Status` (TRUE branch)

**Configuration:**
| Field | Value |
|-------|-------|
| Method | POST |
| URL | `https://queue.fal.run/fal-ai/latentsync` |
| Authentication | Generic Credential Type (Header Auth) |
| Send Headers | On |
| Header Name | `Authorization` |
| Header Value | `Key {{ $('Workflow Configuration').item.json.falApiKey }}` |
| Send Body | On |
| Body Type | JSON |

**JSON Body:**
```javascript
={{ JSON.stringify({
  "video_url": $('Prepare Dialog Script').item.json.videoUrl,
  "audio_url": $json.audio_file.url
}) }}
```

**Notes:**
- `video_url`: Original Kling O1 silent video
- `audio_url`: Generated TTS audio from ElevenLabs

---

#### Node 8: Wait for LatentSync
**Type:** Wait
**Name:** `Wait for LatentSync`
**Position:** After `Submit to LatentSync`

**Configuration:**
| Field | Value |
|-------|-------|
| Resume | After Time Interval |
| Wait Amount | 5 |
| Wait Unit | Seconds |

---

#### Node 9: Get LatentSync Result
**Type:** HTTP Request
**Name:** `Get LatentSync Result`
**Position:** After `Wait for LatentSync`

**Configuration:**
| Field | Value |
|-------|-------|
| Method | GET |
| URL | `={{ $('Submit to LatentSync').item.json.response_url }}` |
| Authentication | Generic Credential Type (Header Auth) |
| Response Format | JSON |

---

#### Node 10: Check LatentSync Status
**Type:** IF
**Name:** `Check LatentSync Status`
**Position:** After `Get LatentSync Result`

**Conditions:**
```
Value 1: {{ $json.status }}
Operation: equals
Value 2: COMPLETED
```

**TRUE branch:** Continue to Download Final Video
**FALSE branch:** Continue to LatentSync Loop Check

---

#### Node 11: LatentSync Loop Check
**Type:** IF
**Name:** `LatentSync Loop Check`
**Position:** FALSE branch of `Check LatentSync Status`

**TRUE branch:** Error handling
**FALSE branch:** Loop back to `Wait for LatentSync`

---

### Stage 4: Output (Modified Existing)

#### Download Final Video (Modified)
**Name:** `Download Final Video` (rename from `Download Kling Video1`)
**Modification:** Update to download from LatentSync output instead of Kling

**URL Expression:**
```javascript
={{ $('Get LatentSync Result').item.json.video.url }}
```

---

## Connection Diagram

```
                                    ┌─────────────────────┐
                                    │  Download Kling     │
                                    │  Video1 (Silent)    │
                                    └──────────┬──────────┘
                                               │
                                               ▼
                                    ┌─────────────────────┐
                                    │  Prepare Dialog     │
                                    │  Script             │
                                    └──────────┬──────────┘
                                               │
                    ┌──────────────────────────┼──────────────────────────┐
                    │         ELEVENLABS TTS PIPELINE                      │
                    │                          │                           │
                    │                          ▼                           │
                    │               ┌─────────────────────┐                │
                    │               │  Submit to          │                │
                    │               │  ElevenLabs TTS     │                │
                    │               └──────────┬──────────┘                │
                    │                          │                           │
                    │                          ▼                           │
                    │               ┌─────────────────────┐                │
                    │        ┌─────▶│  Wait for TTS       │                │
                    │        │      └──────────┬──────────┘                │
                    │        │                 │                           │
                    │        │                 ▼                           │
                    │        │      ┌─────────────────────┐                │
                    │        │      │  Get TTS Result     │                │
                    │        │      └──────────┬──────────┘                │
                    │        │                 │                           │
                    │        │                 ▼                           │
                    │        │      ┌─────────────────────┐                │
                    │        │      │  Check TTS Status   │                │
                    │        │      └──────────┬──────────┘                │
                    │        │           │           │                     │
                    │        │      FALSE │           │ TRUE               │
                    │        │           ▼           │                     │
                    │        │   ┌──────────────┐    │                     │
                    │        └───│TTS Loop Check│    │                     │
                    │            └──────────────┘    │                     │
                    │                                │                     │
                    └────────────────────────────────┼─────────────────────┘
                                                     │
                    ┌────────────────────────────────┼─────────────────────┐
                    │         LATENTSYNC PIPELINE    │                     │
                    │                                ▼                     │
                    │               ┌─────────────────────┐                │
                    │               │  Submit to          │                │
                    │               │  LatentSync         │                │
                    │               └──────────┬──────────┘                │
                    │                          │                           │
                    │                          ▼                           │
                    │               ┌─────────────────────┐                │
                    │        ┌─────▶│  Wait for LatentSync│                │
                    │        │      └──────────┬──────────┘                │
                    │        │                 │                           │
                    │        │                 ▼                           │
                    │        │      ┌─────────────────────┐                │
                    │        │      │  Get LatentSync     │                │
                    │        │      │  Result             │                │
                    │        │      └──────────┬──────────┘                │
                    │        │                 │                           │
                    │        │                 ▼                           │
                    │        │      ┌─────────────────────┐                │
                    │        │      │  Check LatentSync   │                │
                    │        │      │  Status             │                │
                    │        │      └──────────┬──────────┘                │
                    │        │           │           │                     │
                    │        │      FALSE │           │ TRUE               │
                    │        │           ▼           │                     │
                    │        │   ┌──────────────┐    │                     │
                    │        └───│LatentSync    │    │                     │
                    │            │Loop Check    │    │                     │
                    │            └──────────────┘    │                     │
                    │                                │                     │
                    └────────────────────────────────┼─────────────────────┘
                                                     │
                                                     ▼
                                    ┌─────────────────────┐
                                    │  Download Final     │
                                    │  Video (With Audio) │
                                    └──────────┬──────────┘
                                               │
                                               ▼
                                    ┌─────────────────────┐
                                    │  Archive + Route    │
                                    │  Output (existing)  │
                                    └─────────────────────┘
```

---

## Data Flow

### Input Data
| Field | Source | Example |
|-------|--------|---------|
| Silent Video URL | Kling O1 output | `https://fal.ai/files/...mp4` |
| Dialog Script | Predefined | `"Ah, mi amigo! Welcome!"` |
| Voice ID | ElevenLabs | `pNInz6obpgDQGcFmaJgB` |

### Intermediate Data
| Field | Source | Example |
|-------|--------|---------|
| TTS Audio URL | ElevenLabs output | `https://fal.ai/files/...mp3` |

### Output Data
| Field | Source | Example |
|-------|--------|---------|
| Final Video URL | LatentSync output | `https://fal.ai/files/...mp4` |

---

## Configuration Requirements

### Workflow Configuration Node Updates
Add to existing `Workflow Configuration` node:

```json
{
  "falApiKey": "existing",
  "dialogScript": "Ah, mi amigo! Welcome, welcome! Ha ha ha! It is so good to see you! Come, come!",
  "picassoVoiceId": "pNInz6obpgDQGcFmaJgB"
}
```

### ElevenLabs Voice Setup
1. Create or select Spanish-accented male voice in ElevenLabs
2. Note the `voice_id`
3. Add to workflow configuration

---

## Error Handling

### TTS Failures
- Max retries: 10
- On failure: Skip audio, output silent video
- Log error to notification system

### Lip Sync Failures
- Max retries: 15 (longer processing time)
- On failure: Skip audio, output silent video
- Log error to notification system

### Graceful Degradation
If audio pipeline fails, workflow should:
1. Log the error
2. Continue with silent video
3. Mark output as "no audio" in metadata

---

## Testing Plan

### Unit Tests
1. Test ElevenLabs TTS with sample text
2. Test LatentSync with sample video + audio
3. Verify polling loops complete correctly

### Integration Tests
1. Full pipeline with Kling O1 output
2. Verify lip sync quality
3. Test with various Picasso reference images

### Quality Checks
- [ ] Audio duration matches video (~10s)
- [ ] Lip movements appear synchronized
- [ ] Spanish accent is recognizable
- [ ] No audio artifacts or glitches
- [ ] Final video plays correctly

---

## Cost Estimate

| Component | Cost | Frequency |
|-----------|------|-----------|
| Kling O1 | $1.00 | Per video |
| ElevenLabs TTS | ~$0.05 | Per video |
| LatentSync | $0.20 | Per video |
| **Total** | **~$1.25** | Per video |

---

## Implementation Phases

### Phase 1: Basic Implementation
- Add 11 nodes as specified
- Use predefined dialog script
- Test with single Picasso image

### Phase 2: Voice Tuning
- Experiment with ElevenLabs voice settings
- Adjust speed, accent parameters
- Optimize script content

### Phase 3: Error Handling
- Add graceful degradation
- Implement retry logic
- Add logging/notifications

### Phase 4: Optional Enhancements
- GPT-4 dynamic script generation
- Multiple voice options
- Ambient sound layer

---

## Files Created

| File | Purpose |
|------|---------|
| This document | Detailed design specification |
| Research doc | Background research and feasibility |
| Node JSON (future) | Exportable node configurations |

---

## Revision History

| Date | Version | Changes |
|------|---------|---------|
| 2026-01-10 | 1.0 | Initial design |

---

*Design completed: 2026-01-10*
